# 游戏系统重构分析

## 核心玩法定位
**音乐节奏游戏 + 消除玩法 + RPG成长元素**

玩家通过触摸/滑动屏幕，在音乐节奏中切削飞来的敌人（类似水果忍者），通过装备和等级提升来增强战斗能力。

---

## 当前问题分析

### 1. 装备系统设计偏离核心玩法

**当前设计问题**：
- ❌ 装备属性过于RPG化（攻击力+10、防御力+5、速度+2）
- ❌ 特殊效果与音乐节奏玩法脱节（吸血、穿透、暴击等）
- ❌ 装备类型过多（武器、头盔、胸甲、护腿、饰品1、饰品2）
- ❌ 装备效果没有体现在视觉和操作上

**用户期望的设计**：
- ✅ **武器改变攻击轨迹和视觉效果**
  - 匕首：细线攻击，单体击杀（白色）
  - 双剑：双线平行攻击，扩大范围（黄色）
  - 链锤：粗线攻击，范围更大（橙色）
  - 巨剑：超粗线攻击，最大范围（红色）
  
- ✅ **防具增加血量上限**
  - 初始：3颗心
  - 随防具升级：最多10颗心

### 2. 战斗目的不明确

**当前设计问题**：
- ❌ 通关后没有明确的奖励反馈
- ❌ 装备获取方式不清晰（等级解锁？关卡奖励？）
- ❌ 缺少刷装备的动力

**用户期望的设计**：
- ✅ 战斗掉落装备（随机掉落，稀有度不同）
- ✅ 通关解锁下一个地图
- ✅ 三种难度循环（普通→困难→变态）
- ✅ 刷装备作为重复游玩的动力

### 3. 缺少成就和排行榜系统

**当前设计问题**：
- ❌ 没有玩家留存机制
- ❌ 没有竞争性元素
- ❌ 缺少长期目标

**用户期望的设计**：
- ✅ 成就系统（战斗积分排名）
- ✅ 排行榜（记录前10名玩家的名字和头像）
- ✅ 特殊的成就展示场所

### 4. 美术风格不统一

**当前设计问题**：
- ❌ 主界面（Home.tsx）风格简洁现代
- ❌ 地图选择界面（MapSelection.tsx）风格哥特
- ❌ 装备界面（Equipment.tsx）风格现代UI
- ❌ 游戏内（Game.tsx）风格像素哥特

**用户期望的设计**：
- ✅ 所有界面统一哥特风格
- ✅ 与战斗场景的视觉元素一致
- ✅ 像素艺术+哥特元素贯穿始终

---

## 重构计划

### Phase 1: 分析当前问题并制定重构计划 ✅
- [x] 分析装备系统设计偏离
- [x] 分析战斗目的不明确
- [x] 分析缺少成就系统
- [x] 分析美术风格不统一
- [x] 制定详细的重构计划

### Phase 2: 重新设计装备系统数据结构
**武器系统**：
- 数据结构：武器类型、攻击轨迹类型、攻击颜色、攻击宽度
- 武器类型：
  - Dagger（匕首）：单线，宽度2px，白色
  - Dual Swords（双剑）：双线，间距50px，宽度3px，黄色
  - Flail（链锤）：粗线，宽度8px，橙色
  - Greatsword（巨剑）：超粗线，宽度15px，红色
  - Whip（鞭子）：波浪线，宽度5px，紫色
  - Scythe（镰刀）：弧形线，宽度10px，深红色

**防具系统**：
- 数据结构：防具类型、血量加成
- 防具类型：
  - Cloth Armor（布甲）：+1心（总4心）
  - Leather Armor（皮甲）：+2心（总5心）
  - Chain Mail（锁甲）：+3心（总6心）
  - Plate Armor（板甲）：+5心（总8心）
  - Legendary Armor（传说护甲）：+7心（总10心）

**装备稀有度**：
- Common（普通）：白色，基础属性
- Rare（稀有）：蓝色，中等属性
- Epic（史诗）：紫色，高级属性
- Legendary（传说）：橙色，最强属性

### Phase 3: 实现武器系统：不同攻击轨迹和颜色
- [ ] 修改gameEngine.ts中的handleSwipe方法
- [ ] 实现单线攻击（匕首）
- [ ] 实现双线攻击（双剑）
- [ ] 实现粗线攻击（链锤、巨剑）
- [ ] 实现波浪线攻击（鞭子）
- [ ] 实现弧形线攻击（镰刀）
- [ ] 根据装备武器动态改变攻击轨迹和颜色

### Phase 4: 实现防具系统：血量扩展机制
- [ ] 修改gameEngine.ts中的maxLives计算
- [ ] 根据装备防具动态设置最大血量
- [ ] 更新UI显示（心形数量）
- [ ] 测试血量扩展功能

### Phase 5: 实现战斗掉落系统
- [ ] 设计掉落概率算法（普通敌人、BOSS）
- [ ] 实现掉落动画和UI提示
- [ ] 通关时显示装备奖励界面
- [ ] 集成到游戏循环中

### Phase 6: 实现成就排行榜系统
- [ ] 设计排行榜数据结构（LocalStorage）
- [ ] 实现排行榜UI界面
- [ ] 记录玩家最高分数
- [ ] 显示前10名玩家（名字+头像+分数）
- [ ] 添加成就系统（首次通关、连击记录等）

### Phase 7: 统一美术风格：重构所有界面
- [ ] 生成哥特风格的UI元素（按钮、面板、边框）
- [ ] 重构Home.tsx（主界面）
- [ ] 重构MapSelection.tsx（地图选择）
- [ ] 重构Equipment.tsx（装备界面）
- [ ] 重构Lobby.tsx（大厅界面）
- [ ] 统一字体、颜色、图标风格

### Phase 8: 测试并交付重构后的游戏
- [ ] 测试武器系统（所有攻击轨迹）
- [ ] 测试防具系统（血量扩展）
- [ ] 测试掉落系统（装备获取）
- [ ] 测试排行榜系统（分数记录）
- [ ] 测试美术风格统一性
- [ ] 完整游戏流程测试
- [ ] 保存checkpoint并交付

---

## 参考资源

### 开源项目参考
1. **音乐节奏游戏**：
   - [osu!](https://github.com/ppy/osu) - 经典音乐节奏游戏
   - [Rhythm Game](https://github.com/topics/rhythm-game) - GitHub上的节奏游戏项目

2. **装备系统**：
   - [恶魔城月下夜想曲](https://castlevania.fandom.com/wiki/Equipment) - 装备系统设计参考
   - [RPG装备系统](https://github.com/topics/rpg-equipment) - GitHub上的RPG装备系统

3. **Canvas游戏引擎**：
   - [Phaser](https://github.com/photonstorm/phaser) - 2D游戏引擎
   - [PixiJS](https://github.com/pixijs/pixijs) - 2D渲染引擎

### 技术实现参考
- Canvas线条绘制：`ctx.lineWidth`、`ctx.strokeStyle`、`ctx.lineCap`
- 碰撞检测：线段与圆形的碰撞算法
- 粒子系统：已实现，可复用
- LocalStorage：已用于进度和装备存储

---

**更新时间**: 2026年1月5日 18:15
**当前版本**: MVP v6.0
**目标版本**: MVP v7.0 - 重构完成
